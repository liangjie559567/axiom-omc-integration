# HookSystem - é’©å­ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

HookSystem æ˜¯ Axiom-OMC Integration çš„äº‹ä»¶é©±åŠ¨é’©å­ç³»ç»Ÿï¼Œæä¾›æ ‡å‡†åŒ–çš„äº‹ä»¶é’©å­æœºåˆ¶ã€‚

## ç‰¹æ€§

- âœ… äº‹ä»¶æ³¨å†Œå’Œè§¦å‘
- âœ… åŒæ­¥/å¼‚æ­¥é’©å­æ‰§è¡Œ
- âœ… æ¡ä»¶åŒ¹é…å™¨ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- âœ… å‘½ä»¤å’Œå‡½æ•°é’©å­
- âœ… é”™è¯¯éš”ç¦»ï¼ˆé’©å­å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
- âœ… ç»Ÿè®¡ä¿¡æ¯å’Œç›‘æ§

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HookSystem                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - äº‹ä»¶æ³¨å†Œ                                              â”‚
â”‚  - é’©å­ç®¡ç†                                              â”‚
â”‚  - æ‰§è¡Œè°ƒåº¦                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HookExecutor                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - å‘½ä»¤æ‰§è¡Œå™¨ï¼ˆShell å‘½ä»¤ï¼‰                              â”‚
â”‚  - å‡½æ•°æ‰§è¡Œå™¨ï¼ˆJavaScript å‡½æ•°ï¼‰                         â”‚
â”‚  - å˜é‡å±•å¼€                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HookContext                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - äº‹ä»¶åç§°                                              â”‚
â”‚  - äº‹ä»¶æ•°æ®                                              â”‚
â”‚  - æ—¶é—´æˆ³                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ”¯æŒçš„äº‹ä»¶ç±»å‹

### æ ¸å¿ƒäº‹ä»¶

| äº‹ä»¶åç§° | è§¦å‘æ—¶æœº | æ•°æ® |
|---------|---------|------|
| `SessionStart` | ä¼šè¯å¯åŠ¨ | `{ action }` |
| `WorkflowStart` | å·¥ä½œæµå¯åŠ¨ | `{ instanceId, workflowId, workflowName, initialPhase }` |
| `WorkflowEnd` | å·¥ä½œæµå®Œæˆ | `{ instanceId, workflowId, workflowName, duration }` |
| `CommandExecute` | å‘½ä»¤æ‰§è¡Œ | `{ commandName, args }` |
| `AgentDispatch` | Agent è°ƒåº¦ | `{ agentId, agentName, task }` |

### è‡ªå®šä¹‰äº‹ä»¶

ä½ å¯ä»¥å®šä¹‰å’Œè§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼š

```javascript
hookSystem.executeHooks('CustomEvent', {
  customData: 'value'
});
```

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆæ¨èï¼‰

åˆ›å»º `hooks/hooks.json`ï¼š

```json
{
  "hooks": {
    "WorkflowStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Workflow started: ${WORKFLOW_NAME}'",
            "async": false
          }
        ]
      }
    ],
    "WorkflowEnd": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "./hooks/workflow-end.sh ${WORKFLOW_NAME}",
            "async": true
          }
        ]
      }
    ]
  }
}
```

åŠ è½½é…ç½®ï¼š

```javascript
import { hookSystem } from './src/core/HookSystem.js';

await hookSystem.loadFromConfig('./hooks/hooks.json');
```

### 2. ç¼–ç¨‹æ–¹å¼

#### æ³¨å†Œå‡½æ•°é’©å­

```javascript
hookSystem.registerFunctionHook('WorkflowStart', (context) => {
  console.log(`å·¥ä½œæµå¯åŠ¨: ${context.data.workflowName}`);
}, {
  async: false
});
```

#### æ³¨å†Œå‘½ä»¤é’©å­

```javascript
hookSystem.registerHook('WorkflowEnd', {
  hooks: [{
    type: 'command',
    command: 'echo "Workflow completed"',
    async: false
  }]
});
```

#### å¸¦åŒ¹é…å™¨çš„é’©å­

```javascript
hookSystem.registerHook('CommandExecute', {
  matcher: 'commit|push',  // åªåŒ¹é… commit æˆ– push å‘½ä»¤
  hooks: [{
    type: 'function',
    function: (context) => {
      console.log(`Git å‘½ä»¤: ${context.data.commandName}`);
    },
    async: false
  }]
});
```

### 3. è§¦å‘é’©å­

```javascript
// åœ¨ä»£ç ä¸­è§¦å‘é’©å­
await hookSystem.executeHooks('WorkflowStart', {
  workflowName: 'brainstorming',
  WORKFLOW_NAME: 'brainstorming'
});
```

## é’©å­ç±»å‹

### å‘½ä»¤é’©å­ï¼ˆCommand Hookï¼‰

æ‰§è¡Œ Shell å‘½ä»¤ï¼š

```json
{
  "type": "command",
  "command": "echo 'Hello from hook'",
  "async": false
}
```

**å˜é‡å±•å¼€**ï¼š

- `${VAR}` - ç¯å¢ƒå˜é‡æˆ–ä¸Šä¸‹æ–‡å˜é‡
- `$VAR` - ç¯å¢ƒå˜é‡

ç¤ºä¾‹ï¼š

```json
{
  "type": "command",
  "command": "./hooks/notify.sh ${WORKFLOW_NAME} ${USER}",
  "async": true
}
```

### å‡½æ•°é’©å­ï¼ˆFunction Hookï¼‰

æ‰§è¡Œ JavaScript å‡½æ•°ï¼š

```javascript
{
  type: 'function',
  function: (context) => {
    console.log(`Event: ${context.event}`);
    console.log(`Data:`, context.data);
  },
  async: false
}
```

## åŒæ­¥ vs å¼‚æ­¥

### åŒæ­¥é’©å­ï¼ˆasync: falseï¼‰

- ç­‰å¾…é’©å­æ‰§è¡Œå®Œæˆ
- å¯ä»¥è·å–è¿”å›å€¼
- é€‚åˆå…³é”®æ“ä½œ

```json
{
  "type": "command",
  "command": "git status",
  "async": false
}
```

### å¼‚æ­¥é’©å­ï¼ˆasync: trueï¼‰

- ä¸ç­‰å¾…é’©å­æ‰§è¡Œå®Œæˆ
- ç«‹å³è¿”å›
- é€‚åˆé€šçŸ¥ã€æ—¥å¿—ç­‰éå…³é”®æ“ä½œ

```json
{
  "type": "command",
  "command": "./hooks/send-notification.sh",
  "async": true
}
```

## åŒ¹é…å™¨ï¼ˆMatcherï¼‰

ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…äº‹ä»¶ï¼š

```json
{
  "matcher": "startup|resume|clear",
  "hooks": [...]
}
```

åŒ¹é…é€»è¾‘ï¼š

1. æ£€æŸ¥ `data.action`
2. æ£€æŸ¥ `data.name`
3. æ£€æŸ¥ `event` åç§°

ç¤ºä¾‹ï¼š

```javascript
// åªåœ¨ startup æˆ– resume æ—¶æ‰§è¡Œ
hookSystem.registerHook('SessionStart', {
  matcher: 'startup|resume',
  hooks: [...]
});

// è§¦å‘
await hookSystem.executeHooks('SessionStart', {
  action: 'startup'  // åŒ¹é…æˆåŠŸ
});
```

## é”™è¯¯å¤„ç†

é’©å­ç³»ç»Ÿå…·æœ‰é”™è¯¯éš”ç¦»æœºåˆ¶ï¼š

- âœ… é’©å­å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- âœ… é’©å­å¤±è´¥ä¸å½±å“å…¶ä»–é’©å­
- âœ… é”™è¯¯ä¼šè¢«è®°å½•åˆ°æ—¥å¿—
- âœ… ç»Ÿè®¡ä¿¡æ¯åŒ…å«å¤±è´¥æ¬¡æ•°

```javascript
const result = await hookSystem.executeHooks('TestEvent');

console.log(result);
// {
//   event: 'TestEvent',
//   executed: 2,
//   results: [
//     { type: 'function', success: true },
//     { type: 'command', success: false, error: '...' }
//   ]
// }
```

## ç»Ÿè®¡ä¿¡æ¯

è·å–é’©å­ç³»ç»Ÿç»Ÿè®¡ï¼š

```javascript
const stats = hookSystem.getStats();

console.log(stats);
// {
//   registered: 10,    // å·²æ³¨å†Œé’©å­æ•°
//   executed: 50,      // å·²æ‰§è¡Œæ¬¡æ•°
//   failed: 2,         // å¤±è´¥æ¬¡æ•°
//   events: 5,         // äº‹ä»¶ç±»å‹æ•°
//   hooks: 10          // æ€»é’©å­æ•°
// }
```

## é›†æˆç¤ºä¾‹

### WorkflowIntegration é›†æˆ

```javascript
import { hookSystem } from './HookSystem.js';

class WorkflowIntegration {
  async startWorkflow(workflowId, context) {
    // ... å¯åŠ¨å·¥ä½œæµé€»è¾‘

    // è§¦å‘é’©å­
    await hookSystem.executeHooks('WorkflowStart', {
      instanceId,
      workflowId,
      workflowName: workflow.name,
      WORKFLOW_NAME: workflow.name
    });

    return instanceId;
  }

  async completeWorkflow(instanceId) {
    // ... å®Œæˆå·¥ä½œæµé€»è¾‘

    // è§¦å‘é’©å­
    await hookSystem.executeHooks('WorkflowEnd', {
      instanceId,
      workflowName: workflow.name,
      WORKFLOW_NAME: workflow.name,
      duration: completedAt - startedAt
    });

    return true;
  }
}
```

### CommandRouter é›†æˆ

```javascript
import { hookSystem } from './HookSystem.js';

class CommandRouter {
  async execute(commandName, args) {
    // è§¦å‘é’©å­
    await hookSystem.executeHooks('CommandExecute', {
      commandName,
      COMMAND_NAME: commandName,
      args
    });

    // ... æ‰§è¡Œå‘½ä»¤é€»è¾‘
  }
}
```

## ç¤ºä¾‹é’©å­è„šæœ¬

### session-start.sh

```bash
#!/bin/bash
echo "================================================"
echo "  Axiom-OMC Integration - Session Started"
echo "================================================"
echo "Time: $(date)"
echo "User: ${USER}"
echo "Working Directory: $(pwd)"
echo ""
echo "Available Workflows:"
echo "  - brainstorming"
echo "  - writing-plans"
echo "  - executing-plans"
echo "================================================"
```

### workflow-start.sh

```bash
#!/bin/bash
WORKFLOW_NAME="${1:-Unknown}"

echo "================================================"
echo "  Starting Workflow: ${WORKFLOW_NAME}"
echo "================================================"
echo "Time: $(date)"

case "${WORKFLOW_NAME}" in
  "brainstorming")
    echo "ğŸ“‹ Brainstorming Workflow"
    echo "   - Clarify requirements"
    echo "   - Explore design options"
    ;;
  "test-driven-development")
    echo "ğŸ§ª TDD Workflow"
    echo "   - RED: Write failing test"
    echo "   - GREEN: Make it pass"
    echo "   - REFACTOR: Improve code"
    ;;
esac

echo "================================================"
```

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨é…ç½®æ–‡ä»¶

âœ… æ¨èï¼š

```json
{
  "hooks": {
    "WorkflowStart": [...]
  }
}
```

âŒ é¿å…ï¼š

```javascript
// ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
hookSystem.registerHook('WorkflowStart', ...);
```

### 2. å¼‚æ­¥æ‰§è¡Œéå…³é”®æ“ä½œ

âœ… æ¨èï¼š

```json
{
  "type": "command",
  "command": "./hooks/send-notification.sh",
  "async": true  // é€šçŸ¥ä¸å½±å“ä¸»æµç¨‹
}
```

### 3. ä½¿ç”¨åŒ¹é…å™¨å‡å°‘ä¸å¿…è¦çš„æ‰§è¡Œ

âœ… æ¨èï¼š

```json
{
  "matcher": "commit|push",
  "hooks": [...]
}
```

### 4. æä¾›æœ‰æ„ä¹‰çš„ä¸Šä¸‹æ–‡æ•°æ®

âœ… æ¨èï¼š

```javascript
await hookSystem.executeHooks('WorkflowStart', {
  workflowName: 'brainstorming',
  WORKFLOW_NAME: 'brainstorming',  // ç”¨äºå‘½ä»¤å±•å¼€
  initialPhase: 'draft'
});
```

### 5. é”™è¯¯å¤„ç†

```javascript
try {
  await hookSystem.executeHooks('CustomEvent', data);
} catch (error) {
  logger.error(`é’©å­æ‰§è¡Œå¤±è´¥: ${error.message}`);
  // ç»§ç»­ä¸»æµç¨‹
}
```

## è°ƒè¯•

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```javascript
import { Logger } from './logger.js';

const logger = new Logger('HookSystem');
logger.setLevel('debug');
```

### æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```javascript
const stats = hookSystem.getStats();
console.log('é’©å­ç»Ÿè®¡:', stats);
```

### æµ‹è¯•é’©å­

```javascript
// æµ‹è¯•ç‰¹å®šäº‹ä»¶çš„é’©å­
const result = await hookSystem.executeHooks('TestEvent', {
  test: 'data'
});

console.log('æ‰§è¡Œç»“æœ:', result);
```

## æ•…éšœæ’é™¤

### é’©å­æœªæ‰§è¡Œ

1. æ£€æŸ¥äº‹ä»¶åç§°æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥åŒ¹é…å™¨æ˜¯å¦åŒ¹é…
3. æ£€æŸ¥é’©å­æ˜¯å¦å·²æ³¨å†Œ

```javascript
const stats = hookSystem.getStats();
console.log(`å·²æ³¨å†Œ ${stats.events} ä¸ªäº‹ä»¶`);
```

### å‘½ä»¤é’©å­å¤±è´¥

1. æ£€æŸ¥å‘½ä»¤è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥è„šæœ¬æ˜¯å¦æœ‰æ‰§è¡Œæƒé™
3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®

```bash
chmod +x hooks/session-start.sh
```

### å˜é‡æœªå±•å¼€

1. ç¡®ä¿ä½¿ç”¨ `${VAR}` æ ¼å¼
2. ç¡®ä¿å˜é‡åœ¨ä¸Šä¸‹æ–‡æ•°æ®ä¸­
3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®

```javascript
await hookSystem.executeHooks('Event', {
  WORKFLOW_NAME: 'test'  // ç¡®ä¿æä¾›å˜é‡
});
```

## æ€§èƒ½è€ƒè™‘

- âœ… ä½¿ç”¨å¼‚æ­¥é’©å­å¤„ç†è€—æ—¶æ“ä½œ
- âœ… ä½¿ç”¨åŒ¹é…å™¨å‡å°‘ä¸å¿…è¦çš„æ‰§è¡Œ
- âœ… é¿å…åœ¨é’©å­ä¸­æ‰§è¡Œé˜»å¡æ“ä½œ
- âœ… ç›‘æ§é’©å­æ‰§è¡Œæ—¶é—´

## å®‰å…¨è€ƒè™‘

- âš ï¸ éªŒè¯å‘½ä»¤é’©å­çš„æ¥æº
- âš ï¸ é¿å…åœ¨é’©å­ä¸­æ‰§è¡Œä¸å—ä¿¡ä»»çš„ä»£ç 
- âš ï¸ é™åˆ¶é’©å­çš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®
- âš ï¸ ä½¿ç”¨æœ€å°æƒé™åŸåˆ™

## æ€»ç»“

HookSystem æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„äº‹ä»¶é’©å­æœºåˆ¶ï¼Œä½¿ Axiom-OMC Integration å…·æœ‰é«˜åº¦çš„å¯æ‰©å±•æ€§ã€‚é€šè¿‡åˆç†ä½¿ç”¨é’©å­ç³»ç»Ÿï¼Œä½ å¯ä»¥ï¼š

- âœ… åœ¨å…³é”®äº‹ä»¶ç‚¹æ’å…¥è‡ªå®šä¹‰é€»è¾‘
- âœ… å®ç°æ¾è€¦åˆçš„ç³»ç»Ÿé›†æˆ
- âœ… æä¾›æ’ä»¶åŒ–çš„æ‰©å±•èƒ½åŠ›
- âœ… å¢å¼ºç³»ç»Ÿçš„å¯è§‚æµ‹æ€§

## å‚è€ƒèµ„æ–™

- [Superpowers é’©å­ç³»ç»Ÿ](https://github.com/obra/superpowers/tree/main/hooks)
- [WorkflowIntegration æ–‡æ¡£](./workflow-integration.md)
- [æµ‹è¯•ç¤ºä¾‹](../../tests/core/HookSystem.test.js)
