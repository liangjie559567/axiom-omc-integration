---
name: writing-plans
description: 在有规格或需求的多步骤任务时使用，在接触代码之前必须先编写实现计划
---

# 实现规划技能

## 铁律

**在编写任何实现代码之前，必须先完成实现计划。**

```
NO CODE WITHOUT IMPLEMENTATION PLAN FIRST
```

## 核心原则

实现不是即兴发挥。这是一个系统化的规划过程：

- ✅ 先规划实现
- ✅ 分解任务
- ✅ 识别风险
- ✅ 定义检查点
- ✅ 然后才编码
- ❌ 不要边想边写

## 何时需要规划

### 必须规划的场景

**□ 多文件修改（≥3个文件）**
- 跨模块的功能
- 架构级变更
- 重构工作

**□ 多步骤任务（≥5个步骤）**
- 复杂的功能实现
- 数据迁移
- 系统集成

**□ 高风险变更**
- 破坏性 API 变更
- 数据库 schema 变更
- 核心逻辑修改

**□ 不熟悉的领域**
- 新技术栈
- 未接触过的模块
- 复杂的业务逻辑

### 可以跳过规划的场景

**□ 简单修改（<3个文件，<50行）**
- 修复拼写错误
- 调整样式
- 简单的 bug 修复

**□ 明确的单步任务**
- 添加日志
- 更新配置
- 简单的函数提取

---

## 规划流程

### 阶段 1: 理解需求

**输入**: brainstorming 技能的输出（需求文档）

**任务**:
1. 阅读需求文档
2. 理解验收标准
3. 识别技术约束
4. 确认假设已验证

**输出**: 需求理解确认

```markdown
## 需求理解确认
- ✅ 已阅读需求文档
- ✅ 理解所有验收标准
- ✅ 了解技术约束
- ✅ 所有假设已验证
```

### 阶段 2: 技术设计

**任务**:
1. 选择技术方案
2. 设计模块结构
3. 定义接口契约
4. 识别依赖关系

**输出**: 技术设计文档

```markdown
## 技术设计

### 架构概览
[简要描述整体架构]

### 模块划分
- **模块 1**: [职责描述]
- **模块 2**: [职责描述]
- **模块 3**: [职责描述]

### 接口定义
```typescript
// 模块 1 接口
interface Module1 {
  method1(param: Type): ReturnType;
  method2(param: Type): ReturnType;
}

// 模块 2 接口
interface Module2 {
  method1(param: Type): ReturnType;
}
```

### 依赖关系
```
Module1 → Module2 → Module3
```

### 技术选型
- **框架**: [选择的框架] - [理由]
- **库**: [选择的库] - [理由]
- **工具**: [选择的工具] - [理由]
```

### 阶段 3: 任务分解

**任务**:
1. 将实现分解为独立任务
2. 定义任务依赖关系
3. 估算任务复杂度
4. 识别并行机会

**输出**: 任务清单

```markdown
## 任务分解

### 任务 1: [任务名称]
- **描述**: [详细描述]
- **文件**: [涉及的文件]
- **依赖**: [依赖的任务]
- **复杂度**: 低/中/高
- **验收**: [如何验证完成]

### 任务 2: [任务名称]
- **描述**: [详细描述]
- **文件**: [涉及的文件]
- **依赖**: [依赖的任务]
- **复杂度**: 低/中/高
- **验收**: [如何验证完成]

### 并行机会
- 任务 1 和任务 2 可以并行
- 任务 3 和任务 4 可以并行
```

### 阶段 4: 风险识别

**任务**:
1. 识别技术风险
2. 识别业务风险
3. 制定缓解措施
4. 定义回滚方案

**输出**: 风险清单

```markdown
## 风险识别

### 技术风险
| 风险 | 影响 | 概率 | 缓解措施 | 回滚方案 |
|------|------|------|----------|----------|
| [风险 1] | 高/中/低 | 高/中/低 | [措施] | [方案] |
| [风险 2] | 高/中/低 | 高/中/低 | [措施] | [方案] |

### 业务风险
| 风险 | 影响 | 概率 | 缓解措施 | 回滚方案 |
|------|------|------|----------|----------|
| [风险 1] | 高/中/低 | 高/中/低 | [措施] | [方案] |
```

### 阶段 5: 检查点定义

**任务**:
1. 定义关键检查点
2. 设置验证标准
3. 规划审查时机

**输出**: 检查点清单

```markdown
## 检查点

### 检查点 1: 基础设施就绪
- [ ] 数据库 schema 创建
- [ ] API 路由定义
- [ ] 测试框架配置
- **验证**: 运行空测试通过

### 检查点 2: 核心功能完成
- [ ] 核心逻辑实现
- [ ] 单元测试通过
- [ ] 集成测试通过
- **验证**: 所有测试通过

### 检查点 3: 完整功能验证
- [ ] 所有功能实现
- [ ] 所有测试通过
- [ ] 代码审查完成
- **验证**: 满足所有验收标准
```

---

## 实现计划模板

```markdown
# 实现计划：[功能名称]

## 1. 需求概述
**来源**: [需求文档链接]
**目标**: [一句话描述]
**验收标准**: [关键标准]

## 2. 技术设计

### 架构概览
[架构图或描述]

### 模块划分
- **模块 1**: [职责]
- **模块 2**: [职责]

### 接口定义
```typescript
// 关键接口
```

### 数据流
```
输入 → 处理 → 输出
```

## 3. 任务分解

### 批次 1: 基础设施（可并行）
- [ ] 任务 1.1: [描述] - [文件] - [验收]
- [ ] 任务 1.2: [描述] - [文件] - [验收]

### 批次 2: 核心功能（依赖批次 1）
- [ ] 任务 2.1: [描述] - [文件] - [验收]
- [ ] 任务 2.2: [描述] - [文件] - [验收]

### 批次 3: 集成测试（依赖批次 2）
- [ ] 任务 3.1: [描述] - [文件] - [验收]

## 4. 风险与缓解

### 高风险项
1. **风险**: [描述]
   - **影响**: [描述]
   - **缓解**: [措施]
   - **回滚**: [方案]

## 5. 检查点

### 检查点 1: [名称]
- **时机**: [何时检查]
- **标准**: [验证标准]
- **行动**: [通过/失败后的行动]

## 6. 时间估算
- **批次 1**: [估算时间]
- **批次 2**: [估算时间]
- **批次 3**: [估算时间]
- **总计**: [总时间]

## 7. 依赖项
- [ ] 依赖 1: [描述] - [状态]
- [ ] 依赖 2: [描述] - [状态]
```

---

## 规划质量检查

### 在开始实施前，必须通过以下检查：

**□ 1. 完整性检查**
```markdown
- [ ] 所有需求都有对应的任务
- [ ] 所有任务都有验收标准
- [ ] 所有依赖都已识别
- [ ] 所有风险都有缓解措施
```

**□ 2. 可行性检查**
```markdown
- [ ] 技术方案经过验证
- [ ] 任务分解合理（每个任务 < 1天）
- [ ] 依赖关系清晰
- [ ] 时间估算合理
```

**□ 3. 可测试性检查**
```markdown
- [ ] 每个任务都可独立验证
- [ ] 检查点标准清晰
- [ ] 验收标准可测试
- [ ] 回滚方案可执行
```

**无法通过任何检查 → 返回规划阶段，完善计划。**

---

## 常见规划错误

### 错误 1: 任务粒度过大

**❌ 错误示例：**
```markdown
- [ ] 实现用户管理功能
```

**问题**: 任务太大，无法估算，难以验证。

**✅ 正确做法：**
```markdown
- [ ] 创建 User 数据模型
- [ ] 实现用户注册 API
- [ ] 实现用户登录 API
- [ ] 实现用户信息更新 API
- [ ] 编写用户管理测试
```

### 错误 2: 忽略依赖关系

**❌ 错误示例：**
```markdown
- [ ] 实现 API 端点
- [ ] 创建数据库表
- [ ] 编写测试
```

**问题**: 没有明确依赖，可能导致错误的执行顺序。

**✅ 正确做法：**
```markdown
### 批次 1: 数据层
- [ ] 创建数据库表

### 批次 2: API 层（依赖批次 1）
- [ ] 实现 API 端点

### 批次 3: 测试（依赖批次 2）
- [ ] 编写集成测试
```

### 错误 3: 缺少验收标准

**❌ 错误示例：**
```markdown
- [ ] 优化性能
```

**问题**: 无法验证是否完成。

**✅ 正确做法：**
```markdown
- [ ] 优化查询性能
  - **验收**: 查询响应时间从 2s 降至 < 200ms
  - **测试**: 运行性能测试，P95 < 200ms
```

### 错误 4: 没有回滚方案

**❌ 错误示例：**
```markdown
- [ ] 迁移数据库 schema
```

**问题**: 如果失败，无法恢复。

**✅ 正确做法：**
```markdown
- [ ] 迁移数据库 schema
  - **前置**: 备份当前数据库
  - **迁移**: 运行迁移脚本
  - **验证**: 检查数据完整性
  - **回滚**: 如果失败，恢复备份
```

---

## 与其他技能的配合

### 工作流程
```
brainstorming (需求澄清)
    ↓
writing-plans (实现规划) ← 当前技能
    ↓
test-driven-development (测试驱动开发)
    ↓
executing-plans (执行实现)
    ↓
verification-before-completion (验证完成)
```

### 配合原则
1. **输入来源**: brainstorming 的需求文档
2. **输出用途**: 作为 executing-plans 的执行指南
3. **检查点对齐**: 计划中的检查点对应 TDD 的测试阶段
4. **风险追踪**: 识别的风险在实施中持续监控

---

## 实际案例

### 案例 1: 用户认证功能

**需求**: 实现用户注册和登录功能

**实现计划**:
```markdown
# 实现计划：用户认证功能

## 1. 技术设计

### 模块划分
- **AuthService**: 认证逻辑
- **UserRepository**: 用户数据访问
- **TokenService**: JWT token 管理

### 接口定义
```typescript
interface AuthService {
  register(email: string, password: string): Promise<User>;
  login(email: string, password: string): Promise<Token>;
  verifyToken(token: string): Promise<User>;
}
```

## 2. 任务分解

### 批次 1: 数据层
- [ ] 创建 users 表
- [ ] 实现 UserRepository
- [ ] 编写 UserRepository 测试

### 批次 2: 服务层
- [ ] 实现 AuthService.register
- [ ] 实现 AuthService.login
- [ ] 实现 TokenService
- [ ] 编写服务层测试

### 批次 3: API 层
- [ ] 实现 POST /auth/register
- [ ] 实现 POST /auth/login
- [ ] 编写 API 测试

## 3. 风险与缓解

### 高风险项
1. **风险**: 密码存储不安全
   - **缓解**: 使用 bcrypt 哈希
   - **验证**: 安全审查

2. **风险**: Token 泄露
   - **缓解**: 使用 HTTPS，设置短过期时间
   - **验证**: 安全测试

## 4. 检查点

### 检查点 1: 数据层完成
- [ ] users 表创建成功
- [ ] UserRepository 测试通过
- **验证**: 运行数据库测试

### 检查点 2: 服务层完成
- [ ] 所有服务方法实现
- [ ] 服务层测试通过
- **验证**: 运行单元测试

### 检查点 3: API 完成
- [ ] 所有 API 端点实现
- [ ] API 测试通过
- [ ] 安全审查通过
- **验证**: 运行集成测试
```

---

## 记住

**规划原则：**

1. **先规划后编码** - 永远不要边想边写
2. **任务可验证** - 每个任务都有清晰的验收标准
3. **依赖明确** - 清楚任务之间的依赖关系
4. **风险可控** - 识别风险并制定缓解措施
5. **可回滚** - 关键变更都有回滚方案

**不要：**
- ❌ 跳过规划直接编码
- ❌ 任务粒度过大
- ❌ 忽略依赖关系
- ❌ 缺少验收标准
- ❌ 没有回滚方案

**要：**
- ✅ 系统化规划
- ✅ 合理分解任务
- ✅ 明确依赖关系
- ✅ 定义检查点
- ✅ 识别风险

**现在开始实现规划。**
