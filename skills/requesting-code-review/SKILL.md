---
name: requesting-code-review
description: 在完成任务、实现主要功能或合并前使用，以验证工作是否满足要求
---

# 请求代码审查技能

## 核心原则

**在合并代码前，必须经过代码审查以验证质量和正确性。**

代码审查不是形式，而是：
- ✅ 质量保证
- ✅ 知识共享
- ✅ 错误预防
- ✅ 标准执行
- ❌ 不是橡皮图章
- ❌ 不是可选步骤

## 何时请求审查

### 必须请求审查的场景

**□ 功能完成**
- 新功能实现完成
- 所有测试通过
- 验证完成

**□ 重大变更**
- 架构调整
- API 变更
- 数据库 schema 变更

**□ 安全敏感代码**
- 认证/授权逻辑
- 数据加密/解密
- 权限控制

**□ 性能关键代码**
- 核心算法
- 数据库查询
- 缓存策略

### 可以跳过审查的场景

**□ 紧急修复（需事后审查）**
- 生产环境宕机
- 安全漏洞修复
- 数据丢失风险

**□ 文档更新**
- README 更新
- 注释修正
- 文档格式调整

---

## 审查请求流程

### 阶段 1: 自我审查

**在请求他人审查前，必须先自我审查。**

**自我审查清单**:
```markdown
## 自我审查清单

### 代码质量
- [ ] 代码遵循项目风格指南
- [ ] 无明显的代码异味
- [ ] 函数和类职责单一
- [ ] 命名清晰有意义
- [ ] 无重复代码

### 测试覆盖
- [ ] 所有新功能有测试
- [ ] 所有边界条件有测试
- [ ] 所有错误情况有测试
- [ ] 测试覆盖率达标（>80%）

### 文档完整
- [ ] 公共 API 有文档注释
- [ ] 复杂逻辑有解释注释
- [ ] README 已更新（如需要）
- [ ] CHANGELOG 已更新（如需要）

### 验证通过
- [ ] 所有测试通过
- [ ] 类型检查通过
- [ ] Lint 检查通过
- [ ] 构建成功

### 提交规范
- [ ] 提交信息清晰
- [ ] 提交粒度合理
- [ ] 无调试代码
- [ ] 无注释掉的代码
```

**无法通过任何一项 → 修复后再请求审查。**

### 阶段 2: 准备审查材料

**任务**:
1. 编写 PR 描述
2. 准备测试证据
3. 标注关键变更
4. 提供上下文信息

**PR 描述模板**:
```markdown
# PR 标题：[简洁描述变更]

## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 性能优化
- [ ] 文档更新
- [ ] 其他：[说明]

## 变更描述

### 问题
[描述要解决的问题或需求]

### 解决方案
[描述实现方案和关键决策]

### 关键变更
- 变更 1: [文件路径] - [变更说明]
- 变更 2: [文件路径] - [变更说明]
- 变更 3: [文件路径] - [变更说明]

## 测试

### 测试覆盖
- 单元测试: ✅ 通过（新增 12 个测试）
- 集成测试: ✅ 通过
- E2E 测试: ✅ 通过

### 测试证据
```bash
$ npm test
✓ 45 tests passed
Coverage: 92.3%
```

### 手动测试
- [ ] 场景 1: [描述] - ✅ 通过
- [ ] 场景 2: [描述] - ✅ 通过

## 审查要点

### 请重点关注
1. [关键点 1]: [为什么需要关注]
2. [关键点 2]: [为什么需要关注]

### 已知问题
- [问题 1]: [描述和计划]
- [问题 2]: [描述和计划]

## 部署注意事项

### 依赖变更
- [ ] 新增依赖: [列出]
- [ ] 环境变量: [列出]
- [ ] 配置变更: [列出]

### 数据库变更
- [ ] Schema 变更: [描述]
- [ ] 迁移脚本: [路径]
- [ ] 回滚方案: [描述]

### 破坏性变更
- [ ] API 变更: [描述]
- [ ] 迁移指南: [链接]

## 相关链接
- Issue: #[编号]
- 设计文档: [链接]
- 相关 PR: #[编号]

## 检查清单
- [ ] 代码遵循项目规范
- [ ] 所有测试通过
- [ ] 文档已更新
- [ ] 无破坏性变更（或已说明）
- [ ] 已自我审查
```

### 阶段 3: 创建 PR

**任务**:
1. 推送分支到远程
2. 创建 Pull Request
3. 指定审查者
4. 添加标签

**创建 PR 命令**:
```bash
# 1. 推送分支
git push -u origin feature/user-authentication

# 2. 创建 PR（使用 gh CLI）
gh pr create \
  --title "实现用户认证功能" \
  --body-file .github/pr-template.md \
  --base main \
  --head feature/user-authentication \
  --reviewer @team-lead \
  --label "feature,needs-review"

# 3. 查看 PR
gh pr view
```

### 阶段 4: 响应审查

**任务**:
1. 及时响应评论
2. 解释设计决策
3. 修复指出的问题
4. 更新 PR

**响应原则**:
```markdown
## 响应原则

### 1. 及时响应
- 24 小时内回复所有评论
- 说明是否接受建议
- 提供修复时间表

### 2. 尊重反馈
- 认真考虑所有建议
- 不要防御性回应
- 解释不同意的理由

### 3. 清晰沟通
- 说明修复内容
- 标记已解决的评论
- 请求重新审查

### 4. 持续改进
- 记录学到的经验
- 更新编码规范
- 分享最佳实践
```

---

## 审查者选择

### 选择标准

**必须包含的审查者**:
- **代码所有者**: 负责相关模块的人
- **技术专家**: 熟悉相关技术的人
- **团队成员**: 至少一位团队成员

**可选的审查者**:
- **安全专家**: 安全敏感代码
- **性能专家**: 性能关键代码
- **UX 设计师**: UI/UX 变更

### 审查者数量

**推荐配置**:
- **小变更（<100 行）**: 1 位审查者
- **中等变更（100-500 行）**: 2 位审查者
- **大变更（>500 行）**: 3 位审查者
- **关键变更**: 至少 2 位资深审查者

---

## 审查标准

### 代码质量标准

**□ 1. 可读性**
```markdown
- [ ] 命名清晰有意义
- [ ] 函数长度合理（<50 行）
- [ ] 复杂度可控（圈复杂度 <10）
- [ ] 注释适当（复杂逻辑有解释）
```

**□ 2. 可维护性**
```markdown
- [ ] 职责单一
- [ ] 耦合度低
- [ ] 可扩展性好
- [ ] 无重复代码
```

**□ 3. 正确性**
```markdown
- [ ] 逻辑正确
- [ ] 边界条件处理
- [ ] 错误处理完善
- [ ] 无明显 bug
```

**□ 4. 性能**
```markdown
- [ ] 无明显性能问题
- [ ] 算法复杂度合理
- [ ] 资源使用合理
- [ ] 无内存泄漏
```

**□ 5. 安全性**
```markdown
- [ ] 无安全漏洞
- [ ] 输入验证
- [ ] 权限检查
- [ ] 敏感数据保护
```

### 测试标准

**□ 1. 覆盖率**
```markdown
- [ ] 语句覆盖率 >80%
- [ ] 分支覆盖率 >70%
- [ ] 函数覆盖率 >90%
```

**□ 2. 测试质量**
```markdown
- [ ] 测试独立
- [ ] 测试可重复
- [ ] 测试清晰
- [ ] 测试有意义
```

**□ 3. 测试类型**
```markdown
- [ ] 单元测试
- [ ] 集成测试
- [ ] E2E 测试（如需要）
```

---

## 常见问题

### 问题 1: PR 太大

**症状**: PR 包含 >500 行变更，难以审查

**原因**: 任务分解不合理

**解决**:
```markdown
## 拆分 PR

### 原 PR: 用户认证功能（800 行）

### 拆分后:
- PR 1: 数据模型和数据库（150 行）
- PR 2: 认证服务（200 行）
- PR 3: API 端点（200 行）
- PR 4: 前端集成（250 行）

### 优势:
- 每个 PR 更容易审查
- 可以并行审查
- 问题更容易定位
```

### 问题 2: 审查延迟

**症状**: PR 创建后长时间无人审查

**原因**: 审查者不明确或太忙

**解决**:
```markdown
## 加速审查

### 1. 明确审查者
- 指定具体的审查者
- 不要使用团队标签
- 私下提醒审查者

### 2. 提供上下文
- 清晰的 PR 描述
- 标注关键变更
- 提供测试证据

### 3. 合理时机
- 避免周五下午创建 PR
- 避免假期前创建 PR
- 考虑审查者的时区

### 4. 主动跟进
- 24 小时后礼貌提醒
- 询问是否需要更多信息
- 提供审查时间估算
```

### 问题 3: 审查意见冲突

**症状**: 不同审查者提出矛盾的建议

**原因**: 缺乏统一的编码规范

**解决**:
```markdown
## 解决冲突

### 1. 识别冲突
- 列出矛盾的建议
- 理解各自的理由
- 评估影响范围

### 2. 寻求共识
- 组织讨论会议
- 参考编码规范
- 咨询技术负责人

### 3. 记录决策
- 更新编码规范
- 记录决策理由
- 分享给团队

### 4. 执行决策
- 按决策修改代码
- 回复所有审查者
- 请求重新审查
```

---

## 审查反馈处理

### 反馈类型

**1. 必须修复（Blocking）**
```markdown
❌ 必须修复
- 逻辑错误
- 安全漏洞
- 性能问题
- 破坏性变更

处理: 立即修复，更新 PR
```

**2. 建议改进（Non-blocking）**
```markdown
💡 建议改进
- 代码风格
- 命名优化
- 注释补充
- 小重构

处理: 评估后决定是否采纳
```

**3. 讨论（Discussion）**
```markdown
💬 讨论
- 设计方案
- 技术选型
- 最佳实践

处理: 参与讨论，达成共识
```

### 响应模板

**接受建议**:
```markdown
✅ 已修复

感谢指出！已按建议修改：
- [具体修改内容]
- [相关提交]: abc1234

请重新审查。
```

**不接受建议**:
```markdown
💭 不采纳，理由如下

感谢建议！经过考虑，暂不采纳，理由：
- [理由 1]
- [理由 2]

如果您认为这个问题很重要，我们可以进一步讨论。
```

**需要讨论**:
```markdown
💬 需要讨论

这是个好问题！我有以下考虑：
- [考虑 1]
- [考虑 2]

您觉得哪种方案更好？或者我们可以安排时间讨论。
```

---

## 与其他技能的配合

### 工作流程
```
verification-before-completion (验证完成)
    ↓
requesting-code-review (请求代码审查) ← 当前技能
    ↓
receiving-code-review (接收代码审查)
    ↓
finishing-a-development-branch (完成开发分支)
```

### 配合原则
1. **验证先行**: 验证通过后才请求审查
2. **材料完整**: 提供完整的审查材料
3. **及时响应**: 快速响应审查意见
4. **持续改进**: 从审查中学习

---

## 记住

**请求审查原则：**

1. **自我审查先行** - 不要浪费审查者时间
2. **材料完整** - 提供充分的上下文
3. **及时响应** - 24 小时内回复评论
4. **尊重反馈** - 认真考虑所有建议
5. **持续改进** - 从审查中学习

**不要：**
- ❌ 跳过自我审查
- ❌ PR 描述不清晰
- ❌ 忽视审查意见
- ❌ 防御性回应

**要：**
- ✅ 完整的自我审查
- ✅ 清晰的 PR 描述
- ✅ 及时响应反馈
- ✅ 尊重审查者

**现在开始请求代码审查。**
