# /prd - 生成产品需求文档

## 描述

基于用户需求描述，自动生成结构化的产品需求文档（PRD），包括需求分析、功能规格、验收标准、技术方案和风险评估。

## 功能特性

- 📝 自动生成结构化 PRD（遵循标准模板）
- 🎯 智能需求分析（目标、范围、约束）
- ✅ 明确验收标准（可测试、可验证）
- 🏗️ 技术方案建议（架构、技术栈、实现路径）
- ⚠️ 风险识别与缓解策略
- 🔍 自动通过 PRD 质量门检查

## 使用方式

```bash
# 基础用法
/prd "实现用户认证功能"

# 指定输出路径
/prd "实现用户认证功能" --output docs/prd/user-auth.md

# 跳过质量门检查（不推荐）
/prd "实现用户认证功能" --skip-gate
```

## 参数说明

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| 需求描述 | string | ✅ | - | 功能需求的简要描述 |
| --output | string | ❌ | `.omc/prd/prd-{timestamp}.md` | PRD 输出路径 |
| --skip-gate | boolean | ❌ | false | 跳过 PRD 质量门检查 |
| --template | string | ❌ | default | PRD 模板类型（default/minimal/detailed） |

## PRD 文档结构

生成的 PRD 包含以下章节：

### 1. 概述
- 需求背景
- 目标用户
- 核心价值

### 2. 功能需求
- 功能列表（优先级排序）
- 用户故事（As a... I want... So that...）
- 功能详细说明

### 3. 非功能需求
- 性能要求
- 安全要求
- 可用性要求
- 兼容性要求

### 4. 验收标准
- 功能验收标准（可测试）
- 性能验收标准（可量化）
- 用户体验验收标准

### 5. 技术方案
- 架构设计
- 技术栈选择
- 实现路径
- 依赖分析

### 6. 风险评估
- 技术风险
- 业务风险
- 缓解策略

### 7. 时间估算
- 开发工作量
- 测试工作量
- 里程碑规划

## 输出示例

```markdown
# PRD: 用户认证功能

**生成时间**: 2026-02-16 15:30:00
**版本**: 1.0.0
**状态**: ✅ 已通过 PRD 质量门

## 1. 概述

### 1.1 需求背景
系统需要实现用户认证功能，支持用户注册、登录、登出和 Token 刷新。

### 1.2 目标用户
- 终端用户：需要访问受保护资源的用户
- 系统管理员：需要管理用户权限的管理员

### 1.3 核心价值
- 保护系统资源安全
- 提供个性化用户体验
- 支持权限管理和审计

## 2. 功能需求

### 2.1 用户注册 (P0 - 必须)
**用户故事**: 作为新用户，我希望能够注册账号，以便访问系统功能。

**功能详细说明**:
- 支持邮箱 + 密码注册
- 密码强度验证（至少 8 位，包含大小写字母和数字）
- 邮箱验证（发送验证链接）
- 防止重复注册

### 2.2 用户登录 (P0 - 必须)
**用户故事**: 作为已注册用户，我希望能够登录系统，以便访问我的账号。

**功能详细说明**:
- 支持邮箱 + 密码登录
- 返回 JWT Access Token 和 Refresh Token
- 登录失败次数限制（5 次后锁定 15 分钟）
- 记录登录日志

### 2.3 Token 刷新 (P0 - 必须)
**用户故事**: 作为已登录用户，我希望 Token 能够自动刷新，以便保持登录状态。

**功能详细说明**:
- 使用 Refresh Token 获取新的 Access Token
- Access Token 有效期 15 分钟
- Refresh Token 有效期 7 天
- 支持 Token 撤销

### 2.4 用户登出 (P1 - 重要)
**用户故事**: 作为已登录用户，我希望能够安全登出，以便保护账号安全。

**功能详细说明**:
- 撤销当前 Access Token 和 Refresh Token
- 清除服务端会话
- 记录登出日志

## 3. 非功能需求

### 3.1 性能要求
- 登录响应时间 < 500ms (P95)
- Token 验证响应时间 < 50ms (P95)
- 支持 1000 并发登录请求

### 3.2 安全要求
- 密码使用 bcrypt 加密（cost=12）
- JWT 使用 RS256 签名算法
- 支持 HTTPS 传输
- 防止暴力破解（登录失败限制）
- 防止 CSRF 攻击

### 3.3 可用性要求
- 系统可用性 99.9%
- 认证服务独立部署，不影响其他服务

## 4. 验收标准

### 4.1 功能验收标准
- ✅ 用户可以成功注册账号
- ✅ 用户可以使用正确的邮箱和密码登录
- ✅ 用户登录后可以访问受保护的 API
- ✅ Token 过期后可以使用 Refresh Token 刷新
- ✅ 用户可以安全登出

### 4.2 性能验收标准
- ✅ 登录响应时间 < 500ms (P95)
- ✅ Token 验证响应时间 < 50ms (P95)
- ✅ 支持 1000 并发登录请求

### 4.3 安全验收标准
- ✅ 密码不以明文存储
- ✅ JWT Token 使用安全签名算法
- ✅ 登录失败 5 次后账号锁定 15 分钟
- ✅ 所有认证请求通过 HTTPS 传输

## 5. 技术方案

### 5.1 架构设计
```
Client → API Gateway → Auth Service → Database
                     ↓
                  Redis (Token 黑名单)
```

### 5.2 技术栈选择
- **后端框架**: FastAPI 0.109+
- **数据库**: MySQL 8.0 (用户表)
- **缓存**: Redis 7.0 (Token 黑名单、登录限制)
- **加密**: bcrypt (密码加密)
- **JWT**: PyJWT (Token 生成和验证)

### 5.3 实现路径
1. 设计数据库表结构（users, auth_logs）
2. 实现密码加密和验证逻辑
3. 实现 JWT Token 生成和验证
4. 实现注册、登录、登出 API
5. 实现 Token 刷新机制
6. 实现登录失败限制
7. 编写单元测试和集成测试

### 5.4 依赖分析
- **内部依赖**: 数据库服务、Redis 服务
- **外部依赖**: 邮件服务（用于邮箱验证）
- **第三方库**: PyJWT, bcrypt, python-jose

## 6. 风险评估

### 6.1 技术风险
| 风险 | 影响 | 概率 | 缓解策略 |
|------|------|------|----------|
| JWT 密钥泄露 | 高 | 低 | 使用环境变量存储密钥，定期轮换 |
| Redis 故障导致 Token 黑名单失效 | 中 | 中 | 实现降级策略，使用数据库备份 |
| 暴力破解攻击 | 高 | 中 | 实现登录失败限制和验证码 |

### 6.2 业务风险
| 风险 | 影响 | 概率 | 缓解策略 |
|------|------|------|----------|
| 用户忘记密码 | 中 | 高 | 实现密码重置功能 |
| 邮箱验证邮件被拦截 | 中 | 中 | 提供多种验证方式（短信、邮箱） |

## 7. 时间估算

| 任务 | 工作量 | 负责人 | 状态 |
|------|--------|--------|------|
| 数据库设计 | 0.5 天 | Backend | 待开始 |
| API 实现 | 2 天 | Backend | 待开始 |
| 单元测试 | 1 天 | Backend | 待开始 |
| 集成测试 | 1 天 | QA | 待开始 |
| 文档编写 | 0.5 天 | Backend | 待开始 |

**总计**: 5 天

## 8. 附录

### 8.1 API 接口设计
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/login` - 用户登录
- `POST /api/v1/auth/logout` - 用户登出
- `POST /api/v1/auth/refresh` - Token 刷新

### 8.2 数据库表结构
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

**PRD 质量门检查结果**: ✅ 通过
- 完整性: 100% (所有必需章节已包含)
- 清晰度: 95% (需求描述清晰，验收标准明确)
- 可行性: 90% (技术方案可行，风险可控)
```

## PRD 质量门检查

生成的 PRD 会自动通过以下质量门检查：

### 完整性检查
- ✅ 包含概述章节
- ✅ 包含功能需求章节
- ✅ 包含非功能需求章节
- ✅ 包含验收标准章节
- ✅ 包含技术方案章节
- ✅ 包含风险评估章节

### 清晰度检查
- ✅ 需求描述清晰无歧义
- ✅ 验收标准可测试
- ✅ 技术方案具体可行

### 可行性检查
- ✅ 技术栈选择合理
- ✅ 时间估算合理
- ✅ 风险识别完整

## 故障排查

**问题：PRD 生成失败，提示"需求描述过于简单"**
- 提供更详细的需求描述（至少 20 字）
- 包含功能的核心目标和使用场景
- 示例：`/prd "实现用户认证功能，支持邮箱注册、登录、登出和 Token 刷新"`

**问题：PRD 质量门检查失败**
- 查看质量门报告：`.omc/logs/gate_report.json`
- 根据报告修复缺失的章节或内容
- 重新生成 PRD

**问题：PRD 输出路径无法写入**
- 检查目录权限：`ls -la .omc/prd/`
- 创建目录：`mkdir -p .omc/prd/`
- 使用默认路径（不指定 --output）

## 相关命令

- `/start` - 启动系统后使用 /prd
- `/analyze-error` - 分析 PRD 生成错误
- `/knowledge` - 查询 PRD 模板和最佳实践

## 技术实现

PRD 生成使用以下技术：
- **需求分析**: 使用 OpenAI GPT-4o 分析用户需求
- **模板渲染**: 使用 Jinja2 渲染 PRD 模板
- **质量门检查**: 使用规则引擎验证 PRD 完整性
- **文件写入**: 使用 Write 工具保存 PRD 文档

## 注意事项

⚠️ **重要**：
- PRD 生成需要 OpenAI API 密钥（OPENAI_API_KEY）
- 生成时间取决于需求复杂度（通常 10-30 秒）
- 建议在生成后人工审查和完善 PRD

## 版本历史

- **1.0.0** (2026-02-16): 初始版本，支持基础 PRD 生成
